# Pre-pushãƒ•ãƒƒã‚¯ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–

ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ã€Issue #98ã€Œpre-pushãŒã‚ã¡ã‚ƒãã¡ã‚ƒé…ã„ã‹ã‚‚ã—ã‚Œãªã„ã€ã®èª¿æŸ»ã¨è§£æ±ºã®è¨˜éŒ²ã§ã™ã€‚

## å•é¡Œã®æ¦‚è¦

pre-pushãƒ•ãƒƒã‚¯ã®å®Ÿè¡Œæ™‚é–“ãŒéå¸¸ã«é•·ãï¼ˆ140ç§’è¶…ï¼‰ã€é–‹ç™ºä½“é¨“ã‚’å¤§å¹…ã«é˜»å®³ã—ã¦ã„ã¾ã—ãŸã€‚

### ç—‡çŠ¶

- git pushãŒéå¸¸ã«é…ã„
- ãƒ†ã‚¹ãƒˆãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¦å¤±æ•—ã™ã‚‹ã“ã¨ãŒã‚ã‚‹
- é–‹ç™ºè€…ãŒpushã‚’é¿ã‘ã‚‹ã‚ˆã†ã«ãªã‚‹

## åŸå› èª¿æŸ»

### å®Ÿè¡Œæ™‚é–“ã®è©³ç´°åˆ†æ

æ”¹å–„å‰ã®å„ã‚³ãƒãƒ³ãƒ‰ã®å®Ÿè¡Œæ™‚é–“ï¼š

| ã‚³ãƒãƒ³ãƒ‰     | å®Ÿè¡Œæ™‚é–“                  | å•é¡Œç‚¹               |
| ------------ | ------------------------- | -------------------- |
| format-check | ~1.4ç§’                    | æ­£å¸¸                 |
| lint         | ~5.1ç§’                    | è¨±å®¹ç¯„å›²             |
| check-types  | ~6ç§’                      | è¨±å®¹ç¯„å›²             |
| **test**     | **120ç§’è¶…ã§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ** | ğŸš¨ é‡å¤§ãªå•é¡Œ        |
| build        | ~11.6ç§’                   | pre-pushã«ã¯é‡ã™ãã‚‹ |

### æ ¹æœ¬åŸå› 

1. **ãƒ–ãƒ©ã‚¦ã‚¶ãƒ†ã‚¹ãƒˆã®é‡ã•**: webã‚¢ãƒ—ãƒªã§WebDriverIOã‚’ä½¿ã£ãŸãƒ–ãƒ©ã‚¦ã‚¶ãƒ†ã‚¹ãƒˆãŒå®Ÿè¡Œã•ã‚Œã¦ã„ãŸ
2. **é †æ¬¡å®Ÿè¡Œ**: `parallel: false`è¨­å®šã«ã‚ˆã‚Šã€å…¨ã‚³ãƒãƒ³ãƒ‰ãŒé †æ¬¡å®Ÿè¡Œã•ã‚Œã¦ã„ãŸ
3. **ä¸è¦ãªbuild**: pre-pushã§buildãŒå®Ÿè¡Œã•ã‚Œã¦ã„ãŸï¼ˆCI/CDã§å®Ÿè¡Œã™ã¹ãï¼‰

## è§£æ±ºç­–

### 1. ãƒ†ã‚¹ãƒˆç’°å¢ƒã®æœ€é©åŒ–

**å¤‰æ›´å‰ï¼ˆvitest.config.tsï¼‰:**

```typescript
export default defineConfig({
  plugins: [react()],
  test: {
    browser: {
      enabled: true,
      provider: 'webdriverio',
      name: 'chrome',
      headless: true,
    },
    // ...
  },
});
```

**å¤‰æ›´å¾Œ:**

```typescript
export default defineConfig({
  plugins: [react()],
  test: {
    environment: 'jsdom', // ğŸ¯ ãƒ–ãƒ©ã‚¦ã‚¶ â†’ jsdom
    include: ['__tests__/**/*.test.{ts,tsx}'],
    exclude: ['__tests__/api/**/*'],
    setupFiles: ['./vitest.setup.ts'],
    globals: true,
  },
  resolve: {
    alias: {
      '@': path.resolve(__dirname, './src'),
    },
  },
});
```

**åŠ¹æœ**: ãƒ†ã‚¹ãƒˆå®Ÿè¡Œæ™‚é–“ãŒ120ç§’è¶… â†’ 6.8ç§’ï¼ˆ**95%çŸ­ç¸®**ï¼‰

### 2. ãƒ–ãƒ©ã‚¦ã‚¶ãƒ†ã‚¹ãƒˆã®åˆ†é›¢

æ–°ã—ã`vitest.config.browser.ts`ã‚’ä½œæˆã—ã€ãƒ–ãƒ©ã‚¦ã‚¶ãƒ†ã‚¹ãƒˆã‚’åˆ†é›¢ï¼š

```typescript
// vitest.config.browser.ts
export default defineConfig({
  plugins: [react()],
  test: {
    browser: {
      enabled: true,
      provider: 'webdriverio',
      name: 'chrome',
      headless: true,
    },
    // ... å…ƒã®è¨­å®š
  },
});
```

**npm scriptsæ›´æ–°:**

```json
{
  "test": "vitest run",
  "test:watch": "vitest",
  "test:browser": "vitest --config vitest.config.browser.ts",
  "test:browser:run": "vitest run --config vitest.config.browser.ts"
}
```

### 3. Lefthookã®ä¸¦åˆ—å®Ÿè¡ŒåŒ–

**å¤‰æ›´å‰ï¼ˆlefthook.ymlï¼‰:**

```yaml
pre-push:
  parallel: false # ğŸŒ é †æ¬¡å®Ÿè¡Œ
  commands:
    # ...
    build: # ğŸš¨ ä¸è¦ãªbuild
      run: pnpm turbo build
      # ...
```

**å¤‰æ›´å¾Œ:**

```yaml
pre-push:
  parallel: true # âš¡ï¸ ä¸¦åˆ—å®Ÿè¡Œ
  commands:
    format-check:
      run: pnpm run format:check
      # ...
    lint:
      run: pnpm turbo lint
      # ...
    check-types:
      run: pnpm turbo check-types
      # ...
    test:
      run: pnpm turbo test
      # ...
    # buildå‰Šé™¤ - CI/CDã§å®Ÿè¡Œ

# å‡ºåŠ›ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆè¨­å®š
output:
  - execution
```

## çµæœ

### ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ”¹å–„

| é …ç›®           | æ”¹å–„å‰      | æ”¹å–„å¾Œ    | çŸ­ç¸®ç‡  |
| -------------- | ----------- | --------- | ------- |
| **ç·å®Ÿè¡Œæ™‚é–“** | **140ç§’è¶…** | **8.5ç§’** | **94%** |
| lint           | 5.1ç§’       | 153ms     | 98%     |
| check-types    | 6ç§’         | 151ms     | 98%     |
| test           | 120ç§’è¶…     | 6.8ç§’     | 95%     |
| format-check   | 1.4ç§’       | 1.3ç§’     | 7%      |

### TurboRepoã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®åŠ¹æœ

ä¸¦åˆ—å®Ÿè¡Œã¨TurboRepoã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®çµ„ã¿åˆã‚ã›ã§ã€2å›ç›®ä»¥é™ã®å®Ÿè¡Œã¯ã•ã‚‰ã«é«˜é€ŸåŒ–ï¼š

- lint: 153msï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ’ãƒƒãƒˆï¼‰
- check-types: 151msï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ’ãƒƒãƒˆï¼‰

## å­¦ç¿’ãƒã‚¤ãƒ³ãƒˆ

### 1. ãƒ†ã‚¹ãƒˆç’°å¢ƒã®é¸æŠ

**jsdom vs ãƒ–ãƒ©ã‚¦ã‚¶ãƒ†ã‚¹ãƒˆ:**

- **jsdom**: é«˜é€Ÿã€è»½é‡ã€pre-pushã«é©ã—ã¦ã„ã‚‹
- **ãƒ–ãƒ©ã‚¦ã‚¶ãƒ†ã‚¹ãƒˆ**: ã‚ˆã‚Šç¾å®Ÿçš„ã ãŒé‡ã„ã€CI/CDã‚„æ‰‹å‹•å®Ÿè¡Œå‘ã‘

### 2. pre-pushãƒ•ãƒƒã‚¯ã®è¨­è¨ˆåŸå‰‡

**å«ã‚ã‚‹ã¹ãã‚‚ã®:**

- é«˜é€Ÿãªãƒã‚§ãƒƒã‚¯ï¼ˆlint, typecheck, formatï¼‰
- è»½é‡ãªãƒ†ã‚¹ãƒˆï¼ˆunit testsï¼‰

**å«ã‚ã‚‹ã¹ãã§ãªã„ã‚‚ã®:**

- é‡ã„ãƒ“ãƒ«ãƒ‰å‡¦ç†
- E2Eãƒ†ã‚¹ãƒˆ
- ãƒ–ãƒ©ã‚¦ã‚¶ãƒ†ã‚¹ãƒˆ

### 3. ä¸¦åˆ—å®Ÿè¡Œã®é‡è¦æ€§

ãƒ¢ãƒãƒ¬ãƒã§ã¯è¤‡æ•°ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒã‚ã‚‹ãŸã‚ã€ä¸¦åˆ—å®Ÿè¡Œã«ã‚ˆã‚Šï¼š

- TurboRepoã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®æ©æµã‚’æœ€å¤§åŒ–
- å®Ÿè¡Œæ™‚é–“ã‚’å¤§å¹…çŸ­ç¸®
- é–‹ç™ºä½“é¨“ã‚’å‘ä¸Š

### 4. Lefthookã®æœ€é©åŒ–

```yaml
# æ¨å¥¨è¨­å®š
pre-push:
  parallel: true # ä¸¦åˆ—å®Ÿè¡Œ
  commands:
    # é«˜é€Ÿãªãƒã‚§ãƒƒã‚¯ã®ã¿

# å‡ºåŠ›åˆ¶å¾¡
output:
  - execution # å®Ÿè¡Œæƒ…å ±ã®ã¿è¡¨ç¤º

# CIç’°å¢ƒã§ã®ç„¡åŠ¹åŒ–
skip_in_ci: true
```

## é‹ç”¨ä¸Šã®æ³¨æ„ç‚¹

### 1. ãƒ–ãƒ©ã‚¦ã‚¶ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œ

é€šå¸¸ã®é–‹ç™ºã§ã¯ï¼š

```bash
# é«˜é€Ÿãƒ†ã‚¹ãƒˆï¼ˆpre-pushã§å®Ÿè¡Œï¼‰
pnpm test

# ãƒ–ãƒ©ã‚¦ã‚¶ãƒ†ã‚¹ãƒˆï¼ˆæ‰‹å‹•å®Ÿè¡Œï¼‰
pnpm test:browser
```

### 2. CI/CDã§ã®å¯¾å¿œ

- ãƒ“ãƒ«ãƒ‰å‡¦ç†ã¯CI/CDã§å®Ÿè¡Œ
- ãƒ–ãƒ©ã‚¦ã‚¶ãƒ†ã‚¹ãƒˆã‚‚CI/CDã§å®Ÿè¡Œ
- pre-pushã¯é–‹ç™ºè€…ã®ä½“é¨“ã‚’é‡è¦–

### 3. æ®µéšçš„ãªæœ€é©åŒ–

1. **ã¾ãšä¸¦åˆ—å®Ÿè¡Œã‚’æœ‰åŠ¹åŒ–**
2. **é‡ã„ã‚³ãƒãƒ³ãƒ‰ã‚’ç‰¹å®šãƒ»åˆ†é›¢**
3. **ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥ã‚’æœ€é©åŒ–**

## ä»Šå¾Œã®æ”¹å–„æ¡ˆ

### 1. éƒ¨åˆ†ãƒ†ã‚¹ãƒˆã®å®Ÿè£…

å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã«é–¢é€£ã™ã‚‹ãƒ†ã‚¹ãƒˆã®ã¿å®Ÿè¡Œï¼š

```bash
# ä¾‹ï¼šå¤‰æ›´ã•ã‚ŒãŸãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã¿ãƒ†ã‚¹ãƒˆ
pnpm turbo test --filter=...[HEAD^1]
```

### 2. ã‚ˆã‚Šç´°ã‹ã„ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥

- ãƒ•ã‚¡ã‚¤ãƒ«å¤‰æ›´ã«åŸºã¥ãã‚­ãƒ£ãƒƒã‚·ãƒ¥
- ä¾å­˜é–¢ä¿‚ã®å¤‰æ›´æ¤œå‡º

### 3. æ¡ä»¶ä»˜ãå®Ÿè¡Œ

```yaml
# ä¾‹ï¼šTypeScriptãƒ•ã‚¡ã‚¤ãƒ«å¤‰æ›´æ™‚ã®ã¿å‹ãƒã‚§ãƒƒã‚¯
check-types:
  run: pnpm turbo check-types
  files: git diff --name-only HEAD | grep -E '\.(ts|tsx)$'
```

## ã¾ã¨ã‚

pre-pushãƒ•ãƒƒã‚¯ã®æœ€é©åŒ–ã«ã‚ˆã‚Šï¼š

- **é–‹ç™ºä½“é¨“ãŒåŠ‡çš„ã«å‘ä¸Š**ï¼ˆ8.5ç§’ã§å®Œäº†ï¼‰
- **é–‹ç™ºè€…ãŒpushã‚’èºŠèº‡ã—ãªããªã‚‹**
- **CI/CDã¨ã®å½¹å‰²åˆ†æ‹…ãŒæ˜ç¢ºåŒ–**

é‡è¦ãªã®ã¯ã€pre-pushãƒ•ãƒƒã‚¯ã¯ã€Œé«˜é€Ÿãªã‚¬ãƒ¼ãƒ‰ãƒ¬ãƒ¼ãƒ«ã€ã¨ã—ã¦æ©Ÿèƒ½ã—ã€é‡ã„å‡¦ç†ã¯CI/CDã«å§”ã­ã‚‹ã“ã¨ã§ã™ã€‚

---

**é–¢é€£ãƒªãƒ³ã‚¯:**

- [Issue #98](https://github.com/tsuka-ryu/my-blog-with-claude-code-2/issues/98)
- [PR #110](https://github.com/tsuka-ryu/my-blog-with-claude-code-2/pull/110)
- [Lefthook Documentation](https://lefthook.dev/)
- [TurboRepo Documentation](https://turbo.build/repo/docs)
